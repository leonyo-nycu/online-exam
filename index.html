<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線上考卷作答工具</title>
<style>
    /* 確保所有元素從邊緣開始，並清除瀏覽器預設樣式 */
    body, html {
        margin: 0 !important;
        padding: 0 !important;
        touch-action: manipulation; 
        width: 100%;
        min-height: 100vh;
        background-color: #f0f0f0;
    }

    /* 1. 容器樣式 (核心：嘗試擴展到最大寬度) */
    #whiteboard-container {
        display: flex !important;
        justify-content: center !important;
        align-items: flex-start !important;
        
        /* 佔用整個視窗寬度並抵消可能的預設邊距 */
        width: 100vw !important; 
        max-width: 100vw !important;
        margin-left: calc(50% - 50vw) !important;
        margin-right: calc(50% - 50vw) !important;
        margin-top: 0 !important;
        margin-bottom: 20px !important;
        
        padding: 0 !important;
        box-sizing: border-box !important;
    }
    
    /* 2. 繪圖區域包裝器 (設置定位和寬度，用於疊加) */
    #canvas-wrapper {
        position: relative !important; 
        width: 100% !important; 
        max-width: 100% !important;
        overflow: hidden !important; 
        border: 1px solid #333 !important; 
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3) !important;
        background-color: #fff;
    }

    /* 3. 背景圖片 (底層) */
    #wb-background-img {
        display: block !important;
        width: 100% !important; /* 響應式填滿容器 */
        height: auto !important;
    }

    /* 4. Canvas (頂層) */
    #wb-canvas {
        position: absolute !important; 
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;  /* 必須和圖片一樣寬 */
        height: 100% !important; /* 必須和圖片一樣高 */
        display: block !important;
        cursor: crosshair !important;
        background-color: transparent !important; /* 必須透明 */
        z-index: 5 !important; 
    }

    /* 5. 控制項懸浮區 */
    #wb-controls {
        position: absolute !important; 
        top: 10px !important;
        left: 10px !important;
        z-index: 10 !important; 
        
        padding: 8px 12px !important;
        background-color: rgba(255, 255, 255, 0.9) !important;
        border-radius: 8px !important;
        border: 1px solid #ccc !important;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
        
        display: flex !important;
        flex-wrap: wrap !important;
        align-items: center !important;
        user-select: none !important; 
    }
    
    /* 6. 控制項美化 */
    #wb-controls label { display: none !important; }
    #wb-controls input[type="color"] {
        width: 30px; height: 30px; padding: 0; border: none; 
        margin-right: 15px; vertical-align: middle; cursor: pointer;
    }
    #wb-controls input[type="range"] {
        width: 80px; margin-right: 15px; vertical-align: middle;
    }
    #wb-controls button {
        padding: 6px 10px; margin-left: 10px; border: 1px solid #ccc;
        background-color: #e9e9e9; border-radius: 4px; cursor: pointer; font-size: 14px;
    }
</style>
</head>
<body>

<div id="whiteboard-container">
    <div id="canvas-wrapper">
        <img id="wb-background-img" src="" alt="考卷背景圖片" />

        <canvas id="wb-canvas"></canvas>

        <div id="wb-controls">
            <input type="color" id="wb-color" title="筆跡顏色" value="#000000">
            <input type="range" id="wb-width" title="筆跡粗細" min="1" max="15" value="3">
            <button id="wb-clear" title="清除所有作答筆跡">清除</button>
            <button id="wb-save" title="儲存包含作答的圖片">儲存作答</button>
        </div>
    </div>
</div>

<script>
    window.addEventListener('load', function() {
        const canvas = document.getElementById('wb-canvas');
        const ctx = canvas.getContext('2d');
        const backgroundImg = document.getElementById('wb-background-img');
        const clearButton = document.getElementById('wb-clear');
        const saveButton = document.getElementById('wb-save');
        const colorPicker = document.getElementById('wb-color');
        const lineWidthControl = document.getElementById('wb-width');
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // 【！！！此處已設定為您提供的圖片檔名！！！】
        const BACKGROUND_IMAGE_URL = '20251122223641558_page-0001.jpg'; 
        // --------------------------------------------------------
        
        function setCanvasSize() {
            // 確保 Canvas 的繪圖解析度與圖片的原始像素尺寸匹配
            canvas.width = backgroundImg.naturalWidth;
            canvas.height = backgroundImg.naturalHeight;
            
            // 重設繪圖屬性
            ctx.strokeStyle = colorPicker.value;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.lineWidth = lineWidthControl.value;
        }

        backgroundImg.onload = function() {
            setCanvasSize();
            console.log(`圖片載入成功！Canvas 解析度設定為 ${canvas.width}x${canvas.height}`);
        };

        backgroundImg.onerror = function() {
            console.error("圖片載入失敗，請檢查檔名。");
            alert("考卷圖片載入失敗！請確認圖片檔名是否正確。");
        };

        // 將圖片 URL 賦值給 IMG 標籤，啟動載入
        backgroundImg.src = BACKGROUND_IMAGE_URL;

        function getCoordinated(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            let x, y;
            
            if (e.touches && e.touches.length > 0) { // 觸控事件
                x = (e.touches[0].clientX - rect.left) * scaleX;
                y = (e.touches[0].clientY - rect.top) * scaleY;
            } else { // 滑鼠事件
                x = e.offsetX * scaleX;
                y = e.offsetY * scaleY;
            }
            return { x, y, scaleX };
        }

        function draw(e) {
            if (!isDrawing) return; 
            if (e.touches) e.preventDefault();
            
            const { x: currentX, y: currentY, scaleX } = getCoordinated(e);
            
            ctx.strokeStyle = colorPicker.value;
            ctx.lineWidth = lineWidthControl.value * scaleX; 

            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();

            lastX = currentX;
            lastY = currentY;
        }

        function handleStart(e) {
            isDrawing = true;
            if (e.touches) e.preventDefault(); 

            const { x, y } = getCoordinated(e);
            lastX = x;
            lastY = y;
        }

        function handleEnd() {
            isDrawing = false;
        }

        // 事件監聽
        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('touchstart', handleStart, { passive: false });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('mouseup', handleEnd);
        canvas.addEventListener('mouseout', handleEnd);
        canvas.addEventListener('touchend', handleEnd);
        canvas.addEventListener('touchcancel', handleEnd);

        // 4. 控制項功能

        // 清除按鈕：只清除 Canvas (筆跡)
        clearButton.addEventListener('click', () => {
             ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
        
        // 儲存按鈕：合併圖片並下載
        saveButton.addEventListener('click', () => {
            // 1. 創建一個臨時 Canvas 用於合併
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const tempCtx = tempCanvas.getContext('2d');

            // 2. 繪製底層圖片 (同源，可以繪製)
            tempCtx.drawImage(backgroundImg, 0, 0, canvas.width, canvas.height);

            // 3. 繪製頂層筆跡
            tempCtx.drawImage(canvas, 0, 0, canvas.width, canvas.height);

            // 4. 下載合併後的圖片
            const a = document.createElement('a');
            a.href = tempCanvas.toDataURL('image/png');
            a.download = '考卷作答結果.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            tempCanvas.remove();
        });

        colorPicker.addEventListener('change', (e) => {
            ctx.strokeStyle = e.target.value;
        });
        
        lineWidthControl.addEventListener('change', (e) => {
            ctx.lineWidth = e.target.value;
        });
    });
</script>
</body>
</html>